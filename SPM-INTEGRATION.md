# Swift Package Manager Integration Guide

This document provides guidance for maintaining Swift Package Manager (SPM) compatibility and preventing checksum mismatch issues.

## The Checksum Mismatch Issue

### Problem
Swift Package Manager downloads binary targets from GitHub raw URLs (e.g., `https://raw.githubusercontent.com/zoho/SalesIQ-Mobilisten-iOS/v10.1.3/Frameworks/Mobilisten.zip`) and validates them against checksums declared in the SPM Package.swift file. 

**The critical issue occurs when:**
- A release tag is created but the repository's framework files don't match the release assets
- This causes SPM to download one version (from raw URL) but expect a different checksum (from Package.swift)
- Users see errors like: `checksum of downloaded artifact does not match checksum specified by the manifest`

### Root Cause
1. GitHub release assets are uploaded separately from the git tag creation
2. Raw GitHub URLs serve content from the git repository at the tag, not from release assets
3. If the repository files and release assets have different checksums, SPM integration breaks

## Solution

### 1. Ensure Framework Consistency
Before creating any release tags, ensure that the repository's `Frameworks/*.zip` files match the release assets exactly.

**Validation Script:**
```bash
# Validate current checksums
./scripts/validate-checksums.sh

# Validate against a specific release
./scripts/validate-checksums.sh --tag v10.1.3

# Validate against latest tag
./scripts/validate-checksums.sh --latest
```

### 2. Release Process
1. **Build and prepare framework files**
2. **Update local repository with correct framework files**
3. **Commit the framework changes**
4. **Create git tag**
5. **Create GitHub release with assets**
6. **Validate checksums match between raw URL and release assets**
7. **Update SPM repository with correct version and checksums**

### 3. Automated Validation
The repository includes a GitHub Actions workflow (`.github/workflows/validate-checksums.yml`) that:
- Automatically validates checksums on tag pushes
- Compares local repository files with release assets
- Fails the build if checksums don't match
- Provides reference checksums for updating SPM Package.swift

## SPM Package.swift Updates

When updating the SPM repository (`SalesIQ-Mobilisten-iOS-SP`), use the checksums generated by the validation script:

```swift
let mobilisten_version = "v10.1.3"  // Update version
let mobilisten_calls_version = "Calls-1.0.1"

// Update Mobilisten checksum:
.binaryTarget(
    name: "Mobilisten",
    url: "https://raw.githubusercontent.com/zoho/SalesIQ-Mobilisten-iOS/\(mobilisten_version)/Frameworks/Mobilisten.zip",
    checksum: "9d59e2407050387edb406f7527665918143a84b871ff50bbbb107a4fc4b61449"  // Updated checksum
),
```

## Prevention Guidelines

### For Developers
- **Always run `./scripts/validate-checksums.sh --latest` before creating releases**
- **Ensure CI/CD validation passes before tagging**
- **Double-check that framework files in the repository match release assets**

### For CI/CD
- **Checksum validation is automated via GitHub Actions**
- **Release builds will fail if checksums don't match**
- **Manual releases should still validate checksums**

### For SPM Repository Updates
- **Use the reference checksums from validation output**
- **Test SPM integration locally before pushing updates**
- **Coordinate releases between main repository and SPM repository**

## Troubleshooting

### If SPM checksum errors occur:
1. **Run validation script:** `./scripts/validate-checksums.sh --tag <problematic-tag>`
2. **If checksums don't match:** Update repository framework files to match release assets
3. **If tag is already published:** Create a new patch release with corrected files
4. **Update SPM repository:** With correct version and checksums

### Emergency Fix for Existing Tags:
```bash
# Download correct release asset
curl -L -o Frameworks/Mobilisten.zip "https://github.com/zoho/SalesIQ-Mobilisten-iOS/releases/download/v10.1.3/Mobilisten.zip"

# Verify checksum matches
./scripts/validate-checksums.sh --tag v10.1.3

# Commit and create new patch release
git add Frameworks/Mobilisten.zip
git commit -m "Fix: Update framework to match v10.1.3 release asset"
git tag v10.1.4
git push origin v10.1.4
```

## Contact
For SPM integration issues, contact the development team with:
- Validation script output
- Specific error messages
- Xcode and macOS versions
- Steps to reproduce the issue